# Semantic Search + Claude Code Exporter Integration Plan

> This document is intended to be read and executed by **Claude Code** in the
> context of the `my-modular-workspace` project. When additional information is
> needed from the internet or external documentation, use **web MCP**. When you
> need library / tool docs, you may also use **context7 MCP**. For local code
> and docs semantic retrieval, follow the semantic-search integration steps
> below.

---

## 0. High-Level Goals

We want to achieve **two big capabilities**:

1. **Export and archive all Claude Code conversations** per project in
   **Markdown and/or JSON**, managed declaratively via **Home Manager + node2nix**.
   - Tool: **`claude-code-exporter`** (`claude-prompts` CLI). citeturn8search0turn8search1

2. **Enable semantic search** for:
   - Source code for each project
   - Local documentation (e.g. `docs/`, ADRs, notes)
   - Exported Claude conversations (Markdown/JSON generated in step 1)

   using a semantic search MCP server, e.g. **Claude Context**, **Code Context**
   or **claude-context-local**. citeturn7search0turn7search1turn7search2turn7search7

The end state:

- Every project has a **persistent archive** of Claude conversations under a
  stable directory inside the repo (e.g. `docs/claude-sessions/`).
- Claude Code can:
  - **search this archive and the codebase semantically** via an MCP semantic
    search server (e.g. Claude Context / Code Context / claude-context-local).
  - use **context7 MCP** to pull **external** docs (frameworks, libs, etc.). citeturn6search1turn6search5turn6search9
  - use **web MCP** when it needs to open GitHub READMEs or external
    documentation.

---

## 1. Semantic Search Concept & Architecture

### 1.1. Layers of context

We’ll use **three layers** of context:

1. **Local semantic search over code + local docs + exported conversations**
   - Powered by a semantic-search MCP server such as:
     - **Claude Context** (Zilliz) citeturn7search0turn6search7turn6search11
     - **Code Context** (open-source, MCP-compatible semantic code search) citeturn7search2turn7search7turn7search14
     - or **claude-context-local** (fully local embeddings + Postgres/pgvector + Ollama) citeturn7search1turn7search4turn7search9

2. **External documentation search** (frameworks, libraries, SaaS APIs, etc.)
   - Already handled by **context7 MCP** which uses a large doc corpus and
     semantic ranking for up-to-date docs. citeturn6search1turn6search5turn6search9turn6search17

3. **Ad-hoc web access**
   - Through **web MCP** when something is not covered by context7 or project
     docs (e.g. niche GitHub repos, specific blog posts, node2nix examples).

### 1.2. Data that should be indexed semantically

For each project (including `my-modular-workspace`):

- **Code**
  - `./src`, `./pkg`, or equivalent directories
  - Nix files under `./home-manager/` and related tooling

- **Docs & Design**
  - `./docs/` including ADRs and how-to’s
  - `./sessions/` and other project-level notes if appropriate

- **Exported Claude conversations**
  - Directory to standardize, e.g.: `./docs/claude-sessions/`
  - Files generated by `claude-code-exporter` in Markdown and/or JSON

By exporting conversations into a **normal directory inside the repo**, semantic
search tools can treat them as just another set of text files.

### 1.3. Choice of semantic search engine (v1)

For **v1**, keep complexity manageable:

- Prefer a **single semantic search MCP server** for local code/docs.
- Reasonable options:

  1. **Claude Context**
     - Pros: Official from Zilliz; widely used; designed specifically to give
       Claude Code deep context from large codebases. citeturn7search0turn6search11turn7search5
     - Cons: Requires **Milvus/Zilliz Cloud** and **OpenAI embeddings**, which
       adds some infra and external dependencies. citeturn6search7turn7search7

  2. **Code Context MCP server**
     - Pros: Open-source semantic code search engine that integrates with
       Claude Code, Gemini CLI, etc. Designed as an MCP server. citeturn7search2turn7search7turn7search14
     - Cons: Still needs a vector DB (often Milvus) but is focused on code and
       repo indexing. Setup resembles Claude Context.

  3. **claude-context-local**
     - Pros: 100% local, privacy-first, uses Postgres + pgvector + Ollama
       embeddings. No external APIs or cloud costs. citeturn7search1turn7search4turn7search12turn7search9
     - Cons: Requires running Postgres + embeddings backend; a bit heavier to
       bootstrap.

**Recommendation for v1:**

- Start with **Code Context MCP** or **Claude Context** depending on which
  integration guide feels simpler once Claude uses web MCP to read their
  READMEs.
- For a **privacy-first local-only** variant, plan a **v2** migration to
  **claude-context-local** once the pattern is stable.

Claude should:

- Use **web MCP** to open the GitHub pages for:
  - `zilliztech/claude-context` citeturn7search0turn7search3turn7search16
  - and/or the Code Context MCP server citeturn7search2turn7search7turn7search13turn7search14
- Compare setup complexity and infra requirements.
- Choose one implementation path and follow its official installation guide.

---

## 2. Semantic Search – Detailed Implementation Plan

The following tasks assume that **one** semantic MCP server has been selected
(either Claude Context, Code Context, or claude-context-local).

### 2.1. Environment & prerequisites

**Tasks**

1. Ensure **Node.js ≥ 20** is installed (most of these MCP servers require it). citeturn6search7turn8search0

   - If necessary, use `nix` or home-manager to provide a recent Node in the
     dev shell.

2. For Claude Context / Code Context:
   - Use **web MCP** to open their README and identify:
     - Required vector DB (e.g. Milvus or Zilliz Cloud). citeturn7search7turn6search7
     - Required API keys (OpenAI, Zilliz Cloud, etc.).
   - Store credentials using the user’s existing secret management approach
     (e.g. `bw` + environment variables exported in shell profile).

3. For claude-context-local (if chosen):
   - Use **web MCP** to open `MikeO-AI/claude-context-local` README and
     MCP-SETUP-GUIDE. citeturn7search4turn7search12
   - Ensure Postgres and Ollama (or chosen embedding provider) are available.

### 2.2. Register MCP server with Claude Code

**Tasks**

1. Use **web MCP** to find the recommended `claude mcp add` command in the
   chosen server’s README.

2. Run the `claude mcp add` command, for example (template, not literal):

   ```bash
   # Example pattern, exact command from README
   claude mcp add code-context \
     -e VECTOR_DB_URL="..." \
     -e OPENAI_API_KEY="$OPENAI_API_KEY" \
     -- npx code-context-mcp
   ```

3. Confirm the server appears in Claude Code’s MCP list and exposes tools like
   `search_code`, `index_repo`, or equivalent (names vary by implementation).

### 2.3. Define what to index per project

For **`my-modular-workspace`** specifically:

**Targets to index:**

1. **Code & Nix:**
   - `/home/mitsio/.MyHome/MySpaces/my-modular-workspace/home-manager/`
   - Any sub-project repos (e.g. `my-dotfiles`, etc.)

2. **Docs:**
   - `/home/mitsio/.MyHome/MySpaces/my-modular-workspace/docs/`
   - ADRs and design docs inside `docs/`.

3. **Exported Claude sessions:**
   - A standardized directory, e.g.:
     - `/home/mitsio/.MyHome/MySpaces/my-modular-workspace/docs/claude-sessions/`
   - This directory will be populated by `claude-code-exporter` (see section 3).

**Tasks**

1. For the chosen semantic MCP server, identify how to specify indexing roots:
   - For Claude Context: usually via configuration file or CLI command like
     `claude-context index /path/to/repo`. citeturn7search0turn7search5turn6search7
   - For Code Context: via `code-context` config or CLI flags for repositories
     and paths. citeturn7search2turn7search7turn7search14

2. Configure indexing for the three classes above:
   - `home-manager` code
   - `docs/`
   - `docs/claude-sessions/`

3. Exclude noisy directories via `.gitignore` or tool-specific ignore patterns:
   - `.git`, `node_modules`, build artifacts, caches, etc.

### 2.4. Run initial indexing

**Tasks**

1. Run the MCP server’s **index** command for the project:

   ```bash
   # Template – replace with actual command from README
   code-context index /home/mitsio/.MyHome/MySpaces/my-modular-workspace
   ```

2. Monitor logs to confirm:
   - Files are being discovered
   - Chunks/embeddings are being created
   - Vector DB is receiving data

3. After indexing, use Claude Code to run a few test queries, e.g.:
   - "Find Nix code that configures node2nix-based npm tools."
   - "Find documents describing home-manager symlink strategy."
   - "Find conversations where we discussed Atuin integration."

### 2.5. Keep index updated

**Tasks**

1. Decide on an update strategy:
   - Manual: run `index` periodically (e.g. weekly).
   - Scripted: a `make`/`just`/`nix` target to re-index changed files.

2. Optionally configure **incremental indexing** (if supported) to avoid full
   reindex on each run.

3. Document the chosen workflow inside `docs/` (so future-you and Claude know
   how to keep it fresh).

---

## 3. Claude Code Exporter – Declarative Install via Home Manager + node2nix

Now we make **`claude-code-exporter`** available declaratively through
**Home Manager**, using **node2nix** and the existing
`home-manager/npm-tools.nix` architecture. citeturn8search0turn8search1turn0python6turn0python7

### 3.1. Understand existing Nix layout (already present)

Relevant files (from `my-modular-workspace.json`):

- `home-manager/npm-tools.nix` – Nix module that handles npm tools via
  node2nix. It already contains:
  - Setup instructions for running `node2nix`:

    ```bash
    cd ~/.MyHome/MySpaces/my-modular-workspace/home-manager
    node2nix -i npm-packages.json \
      -o npm-node-packages.nix \
      -c npm-default.nix \
      -e npm-node-env.nix
    ```

  - Placeholder `home.packages` using `npmPackages` (once generated).
  - Commented examples for MCP-related npm packages (context7 etc.).

- `home-manager/npm-packages.json` – declarative list of npm packages. Currently
  includes: citeturn0python8

  ```json
  [
    "@anthropic-ai/claude-code",
    "@just-every/mcp-read-website-fast",
    "@upstash/context7-mcp",
    "firecrawl-mcp"
  ]
  ```

- `docs/home-manager/NPM_PACKAGES_INVENTORY.md` – documentation of globally
  installed packages and their purpose. citeturn0python9

### 3.2. Add `claude-code-exporter` to npm-packages.json

**Concept**

We extend `npm-packages.json` so node2nix will generate Nix expressions for
**`claude-code-exporter`**, which provides the `claude-prompts` CLI. citeturn8search0turn8search1

**Tasks**

1. Open `home-manager/npm-packages.json`.
2. Add a new entry:

   ```json
   "claude-code-exporter"
   ```

   e.g. the array becomes:

   ```json
   [
     "@anthropic-ai/claude-code",
     "@just-every/mcp-read-website-fast",
     "@upstash/context7-mcp",
     "firecrawl-mcp",
     "claude-code-exporter"
   ]
   ```

3. Update `docs/home-manager/NPM_PACKAGES_INVENTORY.md` with a new section for
   `claude-code-exporter`:
   - Link to its npm and GitHub page.
   - Short summary of purpose (export Claude Code sessions to JSON/Markdown,
     supports MCP, etc.). citeturn8search0turn8search1turn6search14

### 3.3. Regenerate node2nix outputs

**Tasks**

1. From the `home-manager` directory, run the commands suggested in
   `npm-tools.nix`:

   ```bash
   cd ~/.MyHome/MySpaces/my-modular-workspace/home-manager

   node2nix -i npm-packages.json \
     -o npm-node-packages.nix \
     -c npm-default.nix \
     -e npm-node-env.nix
   ```

2. Confirm the files exist/updated:
   - `npm-node-packages.nix`
   - `npm-default.nix`
   - `npm-node-env.nix`

3. Optionally review `npm-node-packages.nix` to confirm that
   `claude-code-exporter` appears as a package in `npmPackages`.

### 3.4. Wire npm packages into Home Manager

`npm-tools.nix` already has a pattern for exposing node2nix packages via
`home.packages`. We want `claude-code-exporter` (and others) to be installed as
user packages.

**Concept**

- Import the node2nix-generated modules (`npm-node-packages.nix`, etc.).
- Use `npmPackages."claude-code-exporter"` in `home.packages`.

**Tasks**

1. Open `home-manager/npm-tools.nix`.
2. Ensure it imports the node2nix environment, something like:

   ```nix
   let
     node = import ./npm-default.nix { inherit pkgs; }; # or similar
     npmPackages = node.nodePackages;                   # depending on node2nix output
   in
   {
     # ...
   }
   ```

   (Use existing patterns already present in the file as the source of truth.)

3. In the `home.packages` list, add:

   ```nix
   home.packages = with pkgs; [
     # other tools...
     npmPackages."claude-code-exporter"
   ];
   ```

4. Run `home-manager switch` to apply the changes.

5. In a new shell, verify:

   ```bash
   which claude-prompts
   claude-prompts --help
   ```

   Confirm the CLI is available and working. citeturn8search0turn8search1

### 3.5. Define per-project export structure

We want each project to have **stable locations** for exported Claude sessions.
For `my-modular-workspace`, adopt:

- `docs/claude-sessions/` as the root for exports.

**Tasks**

1. Create directory:

   ```bash
   mkdir -p ~/\.MyHome/MySpaces/my-modular-workspace/docs/claude-sessions
   ```

2. Add to `.gitignore` (if you don’t want to commit these archives):

   ```gitignore
   docs/claude-sessions/
   ```

3. Optionally, document this convention in `docs/` (e.g. `docs/PROJECT_LAYOUT.md`).

### 3.6. Create helper script for exports

To simplify exporting, define a project-local script.

**Tasks**

1. Create `scripts/export-claude-history.sh` under
   `my-modular-workspace` (or a similar path):

   ```bash
   #!/usr/bin/env bash
   set -euo pipefail

   PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
   DEST="$PROJECT_ROOT/docs/claude-sessions"

   mkdir -p "$DEST"
   cd "$DEST"

   # Export full conversations for this project in both Markdown and JSON
   claude-prompts --full --all-formats "$PROJECT_ROOT"
   ```

2. Make it executable:

   ```bash
   chmod +x scripts/export-claude-history.sh
   ```

3. (Optional) Add a `Makefile` target:

   ```make
   claude-export:
   	./scripts/export-claude-history.sh
   ```

4. Test:

   ```bash
   cd ~/\.MyHome/MySpaces/my-modular-workspace
   ./scripts/export-claude-history.sh
   ```

5. Confirm files appear in `docs/claude-sessions/` with names like:

   ```text
   docs/claude-sessions/claude-prompts/...
   ```

---

## 4. Connecting Exports to Semantic Search

Once sections **2** and **3** are in place, we connect them:

1. **Exports → Files**
   - `claude-prompts` regularly dumps conversations into
     `docs/claude-sessions/`.

2. **Files → Semantic Index**
   - The chosen semantic MCP server indexes:
     - Code under `home-manager/` and other project dirs.
     - Docs under `docs/`.
     - Exported sessions under `docs/claude-sessions/`.

3. **Semantic Index → Claude Code**
   - When asked a question, Claude can:
     - Use the semantic search MCP tool (e.g. `search_code`, `search_docs`) to
       retrieve relevant snippets from code, docs, and exported conversations.
     - Use **context7 MCP** for external library / framework docs.
     - Use **web MCP** for ad-hoc GitHub/website lookups.

### 4.1. Example usage patterns

After everything is wired, the user can ask inside Claude Code:

1. **Past conversations**
   - "Using semantic search, find the session where we designed the Atuin
      integration and summarize the decisions."
   - Claude should:
     - Ensure exports are up-to-date (optionally instruct user to run
       `claude-export` / `export-claude-history.sh`).
     - Call the semantic search MCP over `docs/claude-sessions/`.

2. **Code + docs**
   - "Find all places in my home-manager configuration where node2nix and npm
      tools are configured, and explain how they work together."

3. **Multi-source reasoning**
   - "Combine my docs about npm tools, my exported Claude sessions about
      node2nix, and the official node2nix documentation (via web MCP) to propose
      a clean refactor of `npm-tools.nix`."

### 4.2. Keeping everything fresh

**Tasks**

1. Establish a habit or lightweight automation to run:
   - `claude-export` at the end of important work sessions.
   - `code-context index` (or equivalent) on a regular cadence.

2. Keep `docs/home-manager/NPM_PACKAGES_INVENTORY.md` updated whenever npm
   packages change, so future maintenance is easier.

3. Optionally add an ADR / design doc summarizing this whole integration so
   both you and Claude have a single canonical reference.

---

## 5. When to Use Which Tool (Mental Model)

- **claude-code-exporter**
  - Turn hidden Claude Code JSONL logs into **explicit, versionable artifacts**
    (Markdown/JSON files) per project.

- **Semantic MCP server (Claude Context / Code Context / claude-context-local)**
  - Provide **deep semantic search** over local code, docs, and exported
    conversations.

- **context7 MCP**
  - Provide **live, up-to-date external documentation** (libraries, services,
    etc.) via semantic search from Upstash’s corpus.

- **web MCP**
  - Raw internet access for GitHub repos, niche blog posts, and any docs not
    covered by context7.

Using these together turns `my-modular-workspace` into a **searchable knowledge
system** instead of a random pile of config files and half-remembered
conversations.

---

End of plan.

