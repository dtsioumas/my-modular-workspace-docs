# New Session Prompt: Autocomplete Implementation (Phase 1)

**Date Created:** 2025-12-05
**Previous Session:** Autocomplete Plans V2 + Secret Management Design
**Current Status:** Investigation Complete, Ready for Implementation
**Next Action:** Integrate butterfish into existing KeePassXC secret management

---

## üéØ Session Goal

Implement butterfish (LLM autocomplete) using the **EXISTING** KeePassXC secret management infrastructure that's already working on shoshin.

**CRITICAL DISCOVERY:** User already has a working systemd + KeePassXC secret loading pattern! We don't need to create a new generic pattern - we need to **extend the existing one**.

---

## üìã What to Do First

**1. Index Your Instructions**
Read your global config and project instructions to understand:
- Tag routing and indexing rules
- Session initialization workflow
- Confidence rules and workflows
- How to use tools properly

**2. Read Required Context** (in this order):

```bash
# Existing secret management setup
docs/integrations/keepassxc-modular-workspace-integration.md  # CRITICAL - Current implementation
docs/integrations/KEEPASSXC_SYSTEMD_SECRET_LOADING.md         # Existing pattern

# Plans created in previous session
docs/AUTOCOMPLETE_PLANS_V2_SUMMARY.md                          # Executive summary
docs/COMPLETE_SECRET_MANAGEMENT_IMPLEMENTATION.md              # Our original design
docs/SESSION_SUMMARY_2025-12-05.md                            # Previous session details

# Detailed plans
docs/commons/toolbox/kitty/PLAN_LLM_AUTOCOMPLETE_BUTTERFISH.md
docs/commons/toolbox/kitty/PLAN_LLM_AUTOCOMPLETE_ULTRATHINK_REVIEW.md

# Architecture
docs/adrs/ADR-009-BASH_SHELL_ENHANCEMENT_CONFIGURATION.md
```

**3. Understand Current State**

The user ALREADY HAS:
- ‚úÖ KeePassXC running with FdoSecrets enabled
- ‚úÖ `secret-tool` installed and working
- ‚úÖ Systemd services loading secrets on login:
  - `load-keepassxc-secrets.service` - Loads API keys to systemd environment
  - `mcp-load-secrets.service` - Loads MCP secrets to file
- ‚úÖ Secrets stored in KeePassXC "Workspace Secrets" group
- ‚úÖ Working pattern: KeePassXC ‚Üí secret-tool ‚Üí systemd environment ‚Üí bash

---

## üîç Investigation Summary

### Existing Secret Loading Pattern

**File:** `/nix/store/.../load-secrets.sh` (managed by home-manager)

**What it does:**
1. Waits for KeePassXC Secret Service on D-Bus
2. Loads secrets using `secret-tool lookup service X key Y`
3. Sets secrets in systemd environment: `systemctl --user set-environment KEY=value`
4. Syncs to D-Bus session: `dbus-update-activation-environment --systemd`
5. Shows desktop notification

**Current secrets loaded:**
- `ANTHROPIC_API_KEY` (service=anthropic, key=apikey)
- `GITHUB_PAT` (service=github, key=pat)
- `RCLONE_CONFIG_PASS` (service=rclone, key=configpassword)

**MCP Secrets** (`~/.local/bin/mcp-load-secrets`):
- Writes to `~/.config/mcp/secrets.env`
- Loads: EXA_API_KEY, BRAVE_API_KEY, FIRECRAWL_API_KEY, CONTEXT7_API_KEY

---

## ‚úÖ What We Designed vs What Exists

### Our Design (from previous session):
```nix
# Generic pattern with keepassxc-secret-loader.nix
# Each tool gets its own systemd service
# Secrets stored in $XDG_RUNTIME_DIR/tool-name-secret
```

### What Actually Exists:
```bash
# Single unified service (load-keepassxc-secrets.service)
# All secrets loaded to systemd environment variables
# Available everywhere via: systemctl --user show-environment
```

**Decision Required:** Should we:
- **Option A:** Extend existing pattern (add OPENAI_API_KEY to load-secrets.sh)
- **Option B:** Create separate service for butterfish (as designed)
- **Option C:** Hybrid - use existing for now, migrate to modular later

**Recommendation:** Option A (extend existing) - simpler, already working, proven pattern.

---

## üìÅ Critical File Locations

### Existing Infrastructure

**Home-Manager:**
- `home-manager/keepassxc.nix` - KeePassXC config, creates load-secrets.sh service
- `home-manager/shell.nix` - Bash config (where we'll add butterfish)
- `home-manager/home.nix` - Main imports

**Scripts:**
- `/nix/store/.../load-secrets.sh` - Main secret loader (generated by home-manager)
- `~/.local/bin/mcp-load-secrets` - MCP-specific loader

**KeePassXC:**
- Database: `~/MyVault/mitsio_secrets.kdbx`
- Group: "Workspace Secrets" (Secret Service enabled)
- Entries must be at ROOT of group, not in subfolders!

### Files to Modify

**For Butterfish Integration:**
1. `home-manager/keepassxc.nix` - Add OPENAI_API_KEY to load-secrets.sh
2. `home-manager/shell.nix` - Add butterfish installation (go install) + bash integration
3. `dotfiles/dot_bashrc.tmpl` - Load API key from environment, init butterfish
4. KeePassXC - Add entry: service=butterfish, key=openai

---

## üöÄ Implementation Steps

### Step 1: Add OpenAI API Key to KeePassXC

```bash
# Store the key
secret-tool store --label="OpenAI API Key (butterfish)" \
  service butterfish \
  key openai

# Test retrieval
secret-tool lookup service butterfish key openai
```

**CRITICAL:** Entry must be in root of "Workspace Secrets" group!

---

### Step 2: Extend load-keepassxc-secrets Service

**File:** `home-manager/keepassxc.nix`

Add to the load-secrets.sh script (around line where other secrets are loaded):

```bash
# Load OpenAI API key for butterfish
OPENAI_API_KEY=$(secret-tool lookup service butterfish key openai 2>/dev/null || true)

if [ -n "$OPENAI_API_KEY" ]; then
  systemctl --user set-environment OPENAI_API_KEY="$OPENAI_API_KEY"
  echo "‚úì Loaded OPENAI_API_KEY into systemd environment"
else
  echo "‚ö† Could not load OPENAI_API_KEY"
fi
```

Add OPENAI_API_KEY to dbus-update-activation-environment call.

---

### Step 3: Install Butterfish via Home-Manager

**File:** `home-manager/shell.nix`

Add Go installation and butterfish activation script:

```nix
home.packages = with pkgs; [
  go  # Required for butterfish
];

home.activation.installButterfish = lib.hm.dag.entryAfter ["writeBoundary"] ''
  # Install butterfish via go install
  if ! command -v butterfish &> /dev/null; then
    $DRY_RUN_CMD ${pkgs.go}/bin/go install github.com/bakks/butterfish@latest
  fi
'';

home.sessionVariables = {
  GOPATH = "${config.home.homeDirectory}/go";
  GOBIN = "${config.home.homeDirectory}/go/bin";
};

home.sessionPath = [
  "${config.home.homeDirectory}/go/bin"
];
```

---

### Step 4: Bash Integration

**File:** `dotfiles/dot_bashrc.tmpl`

**Add HISTIGNORE at top (~line 5):**
```bash
export HISTIGNORE="${HISTIGNORE:+$HISTIGNORE:}*API_KEY*:*TOKEN*:*PASSWORD*:*secret-tool*"
```

**Add butterfish loading (~line 240, after atuin):**
```bash
# ============================================
# Butterfish - LLM Shell Autocomplete
# ============================================
{{ if (eq .chezmoi.os "linux") }}
{{ if (not (env "WSL_DISTRO_NAME")) }}
{{ if (lookPath "butterfish") }}

# Only on local sessions (not SSH)
if [[ -z "$SSH_CONNECTION" ]] && [[ -z "$SSH_CLIENT" ]]; then

  # Load API key from systemd environment
  # (Already set by load-keepassxc-secrets.service)
  if [[ -n "$OPENAI_API_KEY" ]]; then
    eval "$(butterfish shell-init bash)"
    alias bf='butterfish'
    alias bfgoal='butterfish !'
  fi
fi

{{ end }}
{{ end }}
{{ end }}
```

---

### Step 5: Apply and Test

```bash
# 1. Apply home-manager
cd ~/.MyHome/MySpaces/my-modular-workspace/home-manager
home-manager switch

# 2. Verify butterfish installed
which butterfish
butterfish --version

# 3. Restart secret loading service
systemctl --user restart load-keepassxc-secrets.service

# 4. Verify API key loaded
systemctl --user show-environment | grep OPENAI_API_KEY

# 5. Apply chezmoi
cd ~/.MyHome/MySpaces/my-modular-workspace/dotfiles
chezmoi apply ~/.bashrc

# 6. Test in new terminal
source ~/.bashrc
echo $OPENAI_API_KEY  # Should be set
```

---

## ‚ö†Ô∏è Critical Considerations

**Security (from ultrathink review):**
1. ‚úÖ API key in KeePassXC (encrypted)
2. ‚úÖ Loaded via systemd (not in bash history)
3. ‚úÖ HISTIGNORE added (prevents future leaks)
4. ‚úÖ SSH detection (butterfish disabled on remote)
5. ‚ö†Ô∏è Need to add company-specific blocked patterns to config
6. ‚ö†Ô∏è Need to validate API key format

**Cross-Platform:**
1. ‚úÖ Conditional loading (Linux only, not WSL)
2. ‚úÖ Won't break Windows (laptop-system01)

**Performance:**
1. ‚ö†Ô∏è Need to capture baseline before installing
2. ‚ö†Ô∏è Need to measure after installation

---

## üìä Progress Tracking

### Completed (Previous Session)
- ‚úÖ Designed systemd + KeePassXC secret management pattern
- ‚úÖ Created autocomplete plans V2 (classic + LLM)
- ‚úÖ Performed ultrathink reviews (identified 16 critical gaps)
- ‚úÖ Created ADR-009 (Shell Enhancement Configuration)
- ‚úÖ All documentation written and committed

### In Progress (Current Session)
- üîÑ Investigating existing secret management (DONE)
- ‚è≥ Adapting design to existing pattern (NEXT)

### Pending
- ‚è≥ Implement butterfish with existing secret pattern
- ‚è≥ Test butterfish functionality
- ‚è≥ Create butterfish config (blocked patterns, etc.)
- ‚è≥ Implement classic autocomplete (ble.sh)
- ‚è≥ Final testing and validation

---

## ü§î Questions to Ask User

Before implementing, clarify:

1. **Which approach for secret loading?**
   - A: Extend existing load-secrets.sh (recommended)
   - B: Create separate butterfish-api-key.service (as designed)
   - C: Hybrid approach

2. **OpenAI API key:**
   - Do you already have it in KeePassXC?
   - Or should we add it now?

3. **Butterfish config:**
   - Which company-specific patterns to block?
   - Which model (gpt-4 vs gpt-3.5-turbo)?

4. **Testing approach:**
   - Start with butterfish only?
   - Or implement both (ble.sh + butterfish) together?

---

## üìö Todo Items for Next Session

Update `docs/TODO.md`:

```markdown
## Autocomplete Implementation

### Phase 1: Secret Management ‚è≥ IN PROGRESS
- [x] Design generic pattern
- [x] Research existing implementation
- [ ] Add OPENAI_API_KEY to load-secrets.sh
- [ ] Store API key in KeePassXC
- [ ] Test secret loading

### Phase 2: Butterfish (LLM) ‚è≥ PENDING
- [ ] Install butterfish via go
- [ ] Add bash integration
- [ ] Create butterfish config
- [ ] Add company blocked patterns
- [ ] Test functionality
- [ ] Test security (history, SSH, etc.)

### Phase 3: Classic (ble.sh) ‚è≥ PENDING
- [ ] Check ble.sh availability
- [ ] Install via home-manager
- [ ] Configure in .bashrc
- [ ] Test functionality

### Documentation üìù
- [ ] Update plans with actual implementation
- [ ] Document differences from original design
- [ ] Create troubleshooting guide
```

---

## üéØ First Action in New Session

```
Take a deep breath and index your instructions.

Then read these files in order:
1. docs/integrations/keepassxc-modular-workspace-integration.md
2. docs/AUTOCOMPLETE_PLANS_V2_SUMMARY.md
3. This file (NEW_SESSION_PROMPT.md)

After reading, ask me:
- Do you want to extend the existing secret pattern (recommended)?
- Or create a separate service as originally designed?
- Do you already have OpenAI API key in KeePassXC?

Then we'll implement butterfish integration.
```

---

## üìç Current Working Directory

`/home/mitsio/.MyHome/MySpaces/my-modular-workspace/docs`

---

**Status:** ‚úÖ Ready for Implementation
**Confidence:** 0.90 (Band C - Safe to proceed)
**Next Session Duration:** ~1-2 hours for butterfish implementation
