# Shoshin Workspace Remediation Plan

**Created:** 2025-12-13
**Status:** Active
**Priority:** P0-P3 (see categorization below)

## Executive Summary

This plan addresses multiple interconnected issues discovered during a workspace audit on 2025-12-13. The root cause is the KeePassXC Secret Service integration not being consistently available, which cascades into systemd service failures and chezmoi template errors.

## Issue Inventory

### P0 - CRITICAL (Blocking daily work)

| Issue | Status | Impact |
|-------|--------|--------|
| KeePassXC Secret Service not available | PENDING USER ACTION | Blocks chezmoi templates, systemd services |
| Denied secrets (ANTHROPIC_API_KEY, DROPBOX_ACCESS_TOKEN) | PENDING USER ACTION | Blocks API access, gdrive-sync |

### P1 - HIGH (Config drift)

| Issue | Status | Impact |
|-------|--------|--------|
| Zellij config overwritten by autogenerate | FIXED | Was 19KB autogenerated, restored 2KB user config |
| KeePassXC config missing settings | FIXED | Security/GUI settings restored |
| Flameshot config drift | MINOR | Non-critical settings differ |

### P2 - MEDIUM (Missing functionality)

| Issue | Status | Impact |
|-------|--------|--------|
| Spotify not installed | PENDING | User request |
| Audacity not installed | PENDING | User request |
| Audio file associations | PENDING | Depends on app installation |

### P3 - LOW (Technical debt)

| Issue | Status | Impact |
|-------|--------|--------|
| Chezmoi TTY dependency | KNOWN LIMITATION | Blocks non-interactive automation |
| Manual chezmoi apply process | IMPROVEMENT OPPORTUNITY | Leads to config drift |

---

## Phase 1: KeePassXC Secret Service Recovery

**Owner:** User (requires GUI interaction)
**Estimated Time:** 5 minutes

### Steps:

1. **Start KeePassXC main application**
   ```bash
   keepassxc &
   ```

2. **Unlock vault**
   - Open `/home/mitsio/MyVault/mitsio_secrets.kdbx`
   - Enter master password

3. **Fix denied secrets**
   - Go to: **Database → Database Security → Secret Service Integration**
   - Or: **Tools → Settings → Secret Service Integration**
   - Find entries for ANTHROPIC_API_KEY and DROPBOX_ACCESS_TOKEN
   - Remove deny rules / re-enable access

4. **Verify Secret Service is active**
   ```bash
   qdbus org.freedesktop.secrets
   secret-tool lookup service keepassxc
   ```

### Verification:
```bash
# Should return secret value (not error)
secret-tool lookup service keepassxc username ANTHROPIC_API_KEY
```

---

## Phase 2: Systemd Services Recovery

**Prerequisites:** Phase 1 complete
**Estimated Time:** 2 minutes

### Steps:

1. **Reload secrets**
   ```bash
   systemctl --user restart load-keepassxc-secrets.service
   ```

2. **Check service status**
   ```bash
   systemctl --user status load-keepassxc-secrets.service
   journalctl --user -u load-keepassxc-secrets.service -n 20
   ```

3. **Restart dependent services**
   ```bash
   systemctl --user restart gdrive-sync.service
   systemctl --user restart critical-services-health-check.service
   ```

4. **Verify all services healthy**
   ```bash
   systemctl --user --failed
   ```

### Expected Result:
All services should show `active (running)` or `active (exited)` with success.

---

## Phase 3: Config Status Summary

### Configs FIXED during this session:

| Config | Action Taken |
|--------|--------------|
| `~/.config/kitty/kitty.conf` | Restored via `chezmoi apply --force` |
| `~/.config/keepassxc/keepassxc.ini` | Applied chezmoi version with Security settings |
| `~/.config/zellij/config.kdl` | Restored from backup, chezmoi updated |
| `~/.config/mimeapps.list` | Migrated from home-manager to chezmoi |

### Configs verified OK:

| Config | Status |
|--------|--------|
| `~/.config/atuin/config.toml` | Synced |
| `~/.local/share/applications/*.desktop` | Synced |
| `~/.claude/mcp_config.json` | Synced (templates correctly rendered) |

### Configs with minor drift (non-critical):

| Config | Difference |
|--------|------------|
| `~/.config/flameshot/flameshot.ini` | Different `savePath`, `contrastOpacity` settings |

---

## Phase 4: Audio Apps Installation

**Prerequisites:** None
**Estimated Time:** 10 minutes

### Option A: Via Home-Manager (Recommended)

Edit `~/.MyHome/MySpaces/my-modular-workspace/home-manager/home.nix`:

```nix
home.packages = with pkgs; [
  # ... existing packages ...

  # Audio Applications
  spotify        # Music streaming
  audacity       # Audio editing
];
```

Then apply:
```bash
home-manager switch --flake ~/.MyHome/MySpaces/my-modular-workspace/home-manager#mitsio@shoshin
```

### Option B: Via nix-env (Quick install)

```bash
nix-env -iA nixpkgs.spotify nixpkgs.audacity
```

### Update mimeapps.list

After installation, update chezmoi mimeapps.list to add audio associations:

```ini
# In ~/.local/share/chezmoi/private_dot_config/mimeapps.list.tmpl

# ============ AUDIO -> SPOTIFY (Streaming) ============
# For music files, prefer Spotify for playback
audio/mpeg=spotify.desktop;mpv.desktop
audio/mp3=spotify.desktop;mpv.desktop
audio/flac=spotify.desktop;mpv.desktop
audio/ogg=spotify.desktop;mpv.desktop
audio/x-wav=spotify.desktop;mpv.desktop
audio/aac=spotify.desktop;mpv.desktop

# ============ AUDIO EDITING -> AUDACITY ============
# For editing, use Audacity
# Add to [Added Associations] section:
audio/mpeg=audacity.desktop;spotify.desktop;mpv.desktop;
```

Apply:
```bash
chezmoi apply ~/.config/mimeapps.list
```

---

## Phase 5: Future-Proofing Recommendations

### 5.1 KeePassXC Autostart

Ensure KeePassXC starts with session. Check home-manager:

```nix
# In home.nix or separate module
services.keepassxc = {
  enable = true;  # If available in home-manager
};
# Or use systemd user service
```

### 5.2 Chezmoi Apply Automation

Consider adding a systemd timer or hook:

```bash
# ~/.config/systemd/user/chezmoi-apply.timer
[Unit]
Description=Apply chezmoi configs periodically

[Timer]
OnBootSec=5min
OnUnitActiveSec=1h

[Install]
WantedBy=timers.target
```

**Note:** This won't work with KeePassXC templates without TTY. Consider:
- Using `secret-tool` instead of `keepassxcAttribute` in templates
- Pre-loading secrets to environment before chezmoi apply

### 5.3 Config Drift Detection

Add a script to detect drift:

```bash
#!/bin/bash
# ~/.local/bin/chezmoi-drift-check.sh
chezmoi diff 2>/dev/null | head -100
if [ $? -ne 0 ]; then
    notify-send "Chezmoi" "Config drift detected or chezmoi error"
fi
```

### 5.4 Zellij Config Protection

Add to `.chezmoiignore` or use `modify_` script to prevent Zellij from overwriting:

```bash
# Option: Make config read-only after apply
chezmoi apply ~/.config/zellij/config.kdl
chmod 444 ~/.config/zellij/config.kdl
```

---

## Appendix A: Chezmoi TTY Limitation

### Problem
`keepassxcAttribute` function in chezmoi templates requires interactive TTY for password prompts. This blocks:
- `chezmoi status` in non-TTY contexts
- `chezmoi apply` in systemd services
- Automation pipelines

### Affected Templates
- `private_dot_config/rclone/rclone.conf.tmpl`
- Any template using `keepassxcAttribute`

### Workaround Options

1. **Use secret-tool instead:**
   ```
   {{ output "secret-tool" "lookup" "service" "keepassxc" "username" "rclone_client_id" | trim }}
   ```

2. **Pre-load secrets to environment:**
   ```bash
   export RCLONE_CLIENT_ID=$(secret-tool lookup ...)
   chezmoi apply
   ```

3. **Conditional template:**
   ```
   {{ if env "RCLONE_CLIENT_ID" }}
   client_id = {{ env "RCLONE_CLIENT_ID" }}
   {{ else }}
   # Secret not available - run with KeePassXC unlocked
   {{ end }}
   ```

---

## Appendix B: Commands Reference

```bash
# Check KeePassXC Secret Service
qdbus org.freedesktop.secrets

# List accessible secrets
secret-tool search --all service keepassxc

# Reload secrets to systemd environment
systemctl --user restart load-keepassxc-secrets.service

# Check systemd failed services
systemctl --user --failed

# Apply specific chezmoi target
chezmoi apply --force ~/.config/kitty

# Check chezmoi diff (may fail without TTY)
chezmoi diff ~/.config/keepassxc/keepassxc.ini

# Restart all critical services
for svc in load-keepassxc-secrets gdrive-sync critical-services-health-check; do
  systemctl --user restart $svc.service
done
```

---

## Changelog

| Date | Change |
|------|--------|
| 2025-12-13 | Initial plan created after workspace audit |
| 2025-12-13 | Fixed: kitty.conf, keepassxc.ini, zellij config, mimeapps.list |

---

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
