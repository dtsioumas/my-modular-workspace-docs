# ADR-022: Dotfiles as the Single Source of Truth for User Scripts

**Status:** Proposed  
**Date:** 2025-12-27  
**Author:** Mitsos + Codex  
**Related:** ADR-005 (Chezmoi migration criteria), ADR-012 (Chezmoi templates as primary source), ADR-020 (Desktop/k8s slice strategy)

---

## Context

User-facing helper scripts are currently scattered across three places:

1. `toolkit/bin/` – legacy copies of Python/Bash helpers (conflict-manager, mcp-cleanup, rclone wrappers, etc.).
2. `home-manager` – several modules (`rclone-gdrive.nix`, `syncthing-myspaces.nix`, `oom-protected-wrappers.nix`, etc.) embed script bodies directly via `home.file` or `pkgs.writeShellScript`.
3. `dotfiles` (chezmoi) – templates under `dot_local/bin/executable_*`, but many of them are unused because the toolkits/home-manager version masks them.

This duplication causes:

- **Inconsistent updates:** fixing a bug in one copy does not update the others.
- **Security regressions:** scripts generated by `pkgs.writeShellScript` live in the Nix store. Every `home-manager switch` produces a new hash, so KeePassXC treats each invocation as a new binary and prompts for FdoSecrets authorization again (See `journalctl --user` lines referencing `s512z4k3qpx...-load-secrets.sh`).
- **Plasma/service breakage:** symlinking `.config/systemd/user/plasma-plasmashell.service` to a stub file removed KWin/Plasma Exec directives entirely, which removed the panel/activities bar.
- **Tooling drift:** `toolkit/bin` still contains runnable files even though Decision #6 in the Week 52 MCP session already said monitoring scripts migrated to Chezmoi.

---

## Decision

1. **Dotfiles (chezmoi) is the canonical store for every user script deployed to `$HOME/.local/bin`.**  
   - Script source lives in `dotfiles/dot_local/bin/executable_*` (or another dotfiles path if more appropriate).
   - ChezMoi templates control permissions and templating.

2. **Home-Manager and toolkit may reference those scripts, but must not embed or duplicate their logic.**  
   - Home-Manager services/timers call the script path (`$HOME/.local/bin/<name>`).  
   - If a wrapper needs package-specific paths, add them to the dotfiles template or provide env-vars via `home.sessionVariables`.

3. **`toolkit/bin` no longer publishes symlinks into `.local/bin`.**  
   - Existing symlink module (`home-manager/toolkit.nix`) is deprecated.  
   - Scripts that still live exclusively in toolkit must be moved into dotfiles before removal.

4. **Systemd overrides for external services must use drop-ins, not full-unit replacements.**  
   - Drop-ins live in dotfiles (or HM-managed files) and only override the necessary keys (e.g., `[Service] Slice=desktop.slice`), preventing future “Service has no ExecStart” breakages.

---

## Consequences

### Positive
- **Single source of truth** – every script change merges through the dotfiles repo, reviewed like any other config.
- **Stable file paths** – KeePassXC FdoSecrets and other tools stop prompting every rebuild because scripts no longer come from per-generation hash paths.
- **Simpler migrations** – `chezmoi apply` restores all helpers on new hosts automatically.
- **Better observability** – `git diff` in dotfiles shows script changes clearly instead of reconstructing them from generated HM output.

### Negative
- **Initial migration workload** – dozens of scripts must be moved, deduplicated and re-tested.
- **ChezMoi enforcement** – developers must remember to `chezmoi apply ~/.local/bin/<script>` after editing templates or wire the automation to run automatically.
- **toolkit coupling** – Python helpers that import from `toolkit/conflict_manager` still need access to that package; scripts should reference `${HOME}/.MyHome/.../toolkit` explicitly instead of relying on location.

### Neutral / Risks
- **Activation ordering** – home-manager must remove the old `.config/systemd/user/*.service` symlinks before creating drop-in directories.
- **CI coverage** – pre-commit checks should lint scripts from dotfiles rather than the generated copies.

---

## Implementation Plan

1. **Immediate fixes (done in this change set):**
   - New stable script `~/.local/bin/load-keepassxc-secrets.sh` lives in dotfiles and the corresponding systemd unit just executes that file. This eliminates the KeePassXC permission loop.
   - Added systemd drop-ins for `plasma-plasmashell` and `plasma-kwin_x11` while removing the broken full-unit replacements.

2. **Phase 1 – Toolkit cleanup (Week 1):**
   - Enumerate every file under `toolkit/bin` (see `ls toolkit/bin`) and confirm an equivalent `executable_*` template exists in `dotfiles/dot_local/bin`.
   - For scripts that already exist in dotfiles (mcp-cleanup, conflict-manager, etc.), remove the toolkit symlinks via `home-manager/toolkit.nix` and rely on `chezmoi apply`.
   - For scripts not yet templated (e.g., rclone helpers, oom-protected wrappers), move their content into dotfiles and delete the inline HM definitions (starting with `rclone-gdrive.nix`, `productivity-tools-services.nix`, `critical-gui-services.nix`).

3. **Phase 2 – Home-Manager refactor (Week 2):**
   - Replace every `home.file.".local/bin/<script>" = { text = ''...''; }` with a simple `ExecStart = "$HOME/.local/bin/<script>"` assumption, and document that applying dotfiles is a prerequisite.
   - Add a CI/activation guard that fails if `chezmoi diff` reports missing executable scripts.
   - Update pre-commit hooks to lint scripts out of `dot_local/bin/` instead of `toolkit/bin`.

4. **Phase 3 – Documentation & enforcement:**
   - Update docs (`docs/toolkit`, `docs/resource-limiting`, etc.) to note that toolkit is now libraries only, not install location.
   - Add a pre-flight check (similar to `check-adr-compliance.sh`) to assert there are zero managed files under `toolkit/bin` and that `.local/bin` files resolve to the dotfiles tree.

---

## Verification

- `readlink -f ~/.local/bin/conflict-manager` should eventually resolve to the `chezmoi` target, not `/nix/store` or `toolkit/bin`.
- `journalctl --user -u load-keepassxc-secrets.service` must no longer show hash-prefixed script names in ExecStart.
- `systemctl --user status plasma-plasmashell` should succeed after the drop-in is applied.
- CI: add a check that `toolkit/bin` contains no executable files once migration is complete.

---

## Open Questions

- Should `chezmoi apply` run automatically during `home-manager switch` to guarantee scripts are present, or remain a manual step?
- Do we want to keep `toolkit/bin` at all, or split it into a proper Python package inside `toolkit/` with console entry points generated via `pipx`?
- How do we handle scripts needed before secrets or network access (e.g., early boot hooks)?

These will be addressed in follow-up ADRs once the initial migration is complete.
